name: Comprehensive Test Pipeline

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]

jobs:
  # 1ë‹¨ê³„: ì •ì  ë¶„ì„ ë° ë³´ì•ˆ ê²€ì‚¬
  static-analysis:
    name: Static Analysis & Security
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: cd backend && npm ci

      - name: TypeScript Check
        run: cd backend && npm run build
        continue-on-error: false

      - name: Security Audit
        run: cd backend && npm audit --audit-level=moderate
        continue-on-error: true

      - name: ESLint
        run: cd backend && npm run lint 2>/dev/null || true

  # 2ë‹¨ê³„: ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: cd backend && npm ci

      - name: Run unit tests
        run: cd backend && npm test -- --testPathPattern="(comprehensive|DataIntegrity)" --coverage

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./backend/coverage/lcov.info
          flags: unittest
          name: codecov-umbrella

  # 3ë‹¨ê³„: ì†ì„± ê¸°ë°˜ í…ŒìŠ¤íŠ¸
  property-based-tests:
    name: Property-Based Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: cd backend && npm ci

      - name: Run property-based tests
        run: cd backend && npm test -- --testPathPattern="PropertyBased"

  # 4ë‹¨ê³„: í†µí•© í…ŒìŠ¤íŠ¸
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    services:
      backend:
        image: node:18
        options: >-
          --health-cmd "curl -f http://localhost:5000/api/health || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install backend dependencies
        run: cd backend && npm ci

      - name: Start backend server
        run: cd backend && npm run dev &
        continue-on-error: true

      - name: Wait for backend
        run: sleep 10 && curl http://localhost:5000/api/health

      - name: Run integration tests
        run: cd backend && npm test -- --testPathPattern="integration"
        timeout-minutes: 10

  # 5ë‹¨ê³„: ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
  performance-tests:
    name: Performance & Load Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          cd backend && npm ci
          cd .. && npm ci

      - name: Start backend
        run: cd backend && npm run dev &
        continue-on-error: true

      - name: Wait for backend
        run: sleep 10 && curl http://localhost:5000/api/health

      - name: Run performance tests
        run: node performance/load-test-node.js
        timeout-minutes: 5

  # 6ë‹¨ê³„: E2E í…ŒìŠ¤íŠ¸ (Playwright)
  e2e-tests:
    name: E2E Tests (${{ matrix.browser }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        browser: [chromium, firefox, webkit]
      fail-fast: false
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Start backend
        run: cd backend && npm run dev &
        continue-on-error: true

      - name: Wait for services
        run: sleep 10

      - name: Run E2E tests
        run: |
          npx playwright test \
            --project=${{ matrix.browser }} \
            --reporter=html \
            --reporter=json:test-results/results-${{ matrix.browser }}.json
        timeout-minutes: 15
        continue-on-error: true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: e2e-results-${{ matrix.browser }}
          path: test-results/
          retention-days: 7

  # 7ë‹¨ê³„: ë¹Œë“œ ë° ë°°í¬ ì¤€ë¹„
  build:
    name: Build & Prepare Deployment
    runs-on: ubuntu-latest
    needs: [static-analysis, unit-tests, property-based-tests]
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install backend dependencies
        run: cd backend && npm ci

      - name: Build backend
        run: cd backend && npm run build

      - name: Check build output
        run: ls -la backend/dist/

      - name: Create build artifact
        run: tar -czf dist.tar.gz backend/dist/

      - name: Upload build artifact
        uses: actions/upload-artifact@v3
        with:
          name: build-artifact
          path: dist.tar.gz
          retention-days: 7

  # ìµœì¢…: í…ŒìŠ¤íŠ¸ ë³´ê³ ì„œ
  test-report:
    name: Test Report
    runs-on: ubuntu-latest
    needs: [static-analysis, unit-tests, property-based-tests, integration-tests, performance-tests]
    if: always()
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v3
        with:
          path: artifacts/

      - name: Generate summary
        run: |
          echo "## í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ìš”ì•½" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ì •ì  ë¶„ì„: ${{ needs.static-analysis.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ë‹¨ìœ„ í…ŒìŠ¤íŠ¸: ${{ needs.unit-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ì†ì„± ê¸°ë°˜ í…ŒìŠ¤íŠ¸: ${{ needs.property-based-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… í†µí•© í…ŒìŠ¤íŠ¸: ${{ needs.integration-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ì„±ëŠ¥ í…ŒìŠ¤íŠ¸: ${{ needs.performance-tests.result }}" >> $GITHUB_STEP_SUMMARY

      - name: Success notification
        if: success()
        run: echo "ğŸ‰ ëª¨ë“  í…ŒìŠ¤íŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"

      - name: Failure notification
        if: failure()
        run: echo "âŒ ì¼ë¶€ í…ŒìŠ¤íŠ¸ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”."

# ë°°í¬ íŒŒì´í”„ë¼ì¸ (ìˆ˜ë™ íŠ¸ë¦¬ê±°)
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [build]
    if: github.event_name == 'push' && github.ref == 'refs/heads/develop'
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v3
        with:
          name: build-artifact

      - name: Extract artifact
        run: tar -xzf dist.tar.gz

      - name: Deploy to staging
        run: |
          echo "ğŸš€ Deploying to staging environment..."
          # ì‹¤ì œ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì¶”ê°€
          echo "âœ… Staging deployment complete"

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment:
      name: production
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v3
        with:
          name: build-artifact

      - name: Extract artifact
        run: tar -xzf dist.tar.gz

      - name: Deploy to production
        run: |
          echo "ğŸš€ Deploying to production environment..."
          # ì‹¤ì œ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì¶”ê°€
          echo "âœ… Production deployment complete"
