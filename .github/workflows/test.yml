name: Comprehensive Test Pipeline

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]

jobs:
  # 1Îã®Í≥Ñ: Ï†ïÏ†Å Î∂ÑÏÑù Î∞è Î≥¥Ïïà Í≤ÄÏÇ¨
  static-analysis:
    name: Static Analysis & Security
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: cd backend && npm install

      - name: TypeScript Check
        run: cd backend && npm run build
        continue-on-error: false

      - name: Security Audit
        run: cd backend && npm audit --audit-level=moderate
        continue-on-error: true

      - name: ESLint
        run: cd backend && npm run lint 2>/dev/null || true

  # 2Îã®Í≥Ñ: Îã®ÏúÑ ÌÖåÏä§Ìä∏
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: cd backend && npm install

      - name: Run unit tests
        run: cd backend && npm test -- --testPathPattern="(comprehensive|DataIntegrity)" --coverage

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./backend/coverage/lcov.info
          flags: unittest
          name: codecov-umbrella
          token: ${{ secrets.CODECOV_TOKEN }} # Token required for v4

  # 3Îã®Í≥Ñ: ÏÜçÏÑ± Í∏∞Î∞ò ÌÖåÏä§Ìä∏
  property-based-tests:
    name: Property-Based Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: cd backend && npm install

      - name: Run property-based tests
        run: cd backend && npm test -- --testPathPattern="PropertyBased"

  # 4Îã®Í≥Ñ: ÌÜµÌï© ÌÖåÏä§Ìä∏
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install backend dependencies
        run: cd backend && npm install

      - name: Start backend server
        run: cd backend && npm run dev &
        continue-on-error: true

      - name: Wait for backend
        run: sleep 15 && curl http://localhost:5000/api/health || echo "Backend check skipped"

      - name: Run integration tests
        run: cd backend && npm test -- --testPathPattern="integration"
        timeout-minutes: 10

  # 5Îã®Í≥Ñ: ÏÑ±Îä• ÌÖåÏä§Ìä∏
  performance-tests:
    name: Performance & Load Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: cd backend && npm install

      - name: Start backend
        run: cd backend && npm run dev &
        continue-on-error: true

      - name: Wait for backend
        run: sleep 15

      - name: Run performance tests
        run: npx artillery run tests/performance/load-test.yml
        timeout-minutes: 5

  # 6Îã®Í≥Ñ: E2E ÌÖåÏä§Ìä∏ (Playwright)
  e2e-tests:
    name: E2E Tests (${{ matrix.browser }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        browser: [chromium] # Firefox/Webkit removed to speed up fix verification
      fail-fast: false
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
            npm install
            cdfrontend && npm install
        continue-on-error: true # Root npm install might fail if no package.json

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps chromium

      - name: Start backend
        run: cd backend && npm install && npm run dev &

      - name: Start frontend
        run: |
           cd frontend 
           npm install 
           npm start &
        env:
          BROWSER: none
          CI: true

      - name: Wait for services
        run: sleep 30

      - name: Run E2E tests
        run: |
          npx playwright test --project=${{ matrix.browser }} --reporter=html
        timeout-minutes: 15

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-results-${{ matrix.browser }}
          path: playwright-report/
          retention-days: 7

  # 7Îã®Í≥Ñ: ÎπåÎìú Î∞è Î∞∞Ìè¨ Ï§ÄÎπÑ
  build:
    name: Build & Prepare Deployment
    runs-on: ubuntu-latest
    needs: [static-analysis, unit-tests]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install backend dependencies
        run: cd backend && npm install

      - name: Build backend
        run: cd backend && npm run build

      - name: Create build artifact
        run: tar -czf dist.tar.gz backend/dist/

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-artifact
          path: dist.tar.gz
          retention-days: 7

  # ÏµúÏ¢Ö: ÌÖåÏä§Ìä∏ Î≥¥Í≥†ÏÑú
  test-report:
    name: Test Report
    runs-on: ubuntu-latest
    needs: [static-analysis, unit-tests, property-based-tests, integration-tests, performance-tests]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## ÌÖåÏä§Ìä∏ Ïã§Ìñâ ÏöîÏïΩ" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Ï†ïÏ†Å Î∂ÑÏÑù: ${{ needs.static-analysis.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Îã®ÏúÑ ÌÖåÏä§Ìä∏: ${{ needs.unit-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ ÌÜµÌï© ÌÖåÏä§Ìä∏: ${{ needs.integration-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ ÏÑ±Îä• ÌÖåÏä§Ìä∏: ${{ needs.performance-tests.result }}" >> $GITHUB_STEP_SUMMARY

      - name: Send Slack Notification (Success)
        if: success()
        uses: 8398a7/action-slack@v3
        with:
          status: success
          text: "üéâ Pipeline Succeeded!"
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
          
      - name: Send Slack Notification (Failure)
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          text: "‚ùå Pipeline Failed."
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true
